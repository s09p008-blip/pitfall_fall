<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>åœ°è¡¨å¾˜å¾Šç”Ÿç‰© Ã— ãƒ”ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒˆãƒ©ãƒƒãƒ—ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¯¾ç…§å®Ÿé¨“ç‰ˆï¼‰</title>
<style>
  :root{
    --bg:#eef2f6;
    --panel:#ffffff;
    --ink:#1f2937;
    --muted:#6b7280;
    --accent:#3b82f6;
    --accent2:#10b981;
    --warn:#ef4444;
    --shadow:0 8px 24px rgba(15,23,42,0.1);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); 
    font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", "Helvetica", Arial, sans-serif;}
  
  .app{
    display:grid;
    grid-template-columns: 1fr 360px;
    grid-template-rows: auto 1fr 280px;
    gap:14px;
    height:100vh; padding:14px;
    grid-template-areas:
      "tabs tabs"
      "sim panel"
      "results panel";
  }
  
  @media (max-width: 1200px) {
    .app {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto auto auto;
      grid-template-areas:
        "tabs"
        "panel"
        "sim"
        "results";
      height: auto;
      min-height: 100vh;
    }
    #simWrap { min-height: 400px; }
  }
  
  /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
  .tab-nav{
    grid-area: tabs;
    display: flex;
    gap: 8px;
    background: var(--panel);
    padding: 12px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  
  .tab-btn{
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
  }
  
  .tab-btn.active{
    background: var(--accent);
    color: white;
  }
  
  .tab-btn:hover:not(.active){
    background: #f3f4f6;
  }
  
  /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  .tab-content{
    display: none;
  }
  
  .tab-content.active{
    display: contents;
  }
  
  /* ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
  #worksheetView{
    grid-area: sim;
    grid-row: sim / span 2;
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 30px 40px;
    overflow-y: auto;
    max-height: calc(100vh - 100px);
  }
  
  .worksheet-header{
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 3px solid var(--ink);
  }
  
  .worksheet-header h1{
    font-size: 22px;
    margin: 0 0 10px 0;
  }
  
  .worksheet-section{
    margin: 25px 0;
    padding: 20px;
    background: #f9fafb;
    border-radius: 10px;
    border-left: 4px solid var(--accent);
  }
  
  .worksheet-section h2{
    font-size: 18px;
    margin: 0 0 15px 0;
    color: var(--accent);
  }
  
  .worksheet-section h3{
    font-size: 16px;
    margin: 20px 0 10px 0;
    color: var(--ink);
  }
  
  .worksheet-section p, .worksheet-section li{
    line-height: 1.8;
    margin: 10px 0;
  }
  
  .input-area{
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 15px;
    min-height: 80px;
    margin: 15px 0;
  }
  
  .input-area textarea{
    width: 100%;
    min-height: 60px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 10px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
  }
  
  .comparison-table{
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    background: white;
    font-size: 13px;
  }
  
  .comparison-table th, .comparison-table td{
    border: 1px solid #d1d5db;
    padding: 10px 8px;
    text-align: center;
  }
  
  .comparison-table th{
    background: #f3f4f6;
    font-weight: 600;
  }
  
  .comparison-table td:first-child{
    text-align: left;
    font-weight: 600;
  }
  
  .comparison-table input[type="number"]{
    width: 60px;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 4px;
    font-size: 13px;
    text-align: center;
  }
  
  .comparison-table .env-values{
    font-size: 11px;
    color: var(--muted);
  }
  
  .highlight-box{
    background: #dbeafe;
    border: 2px solid #3b82f6;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
  }
  
  .highlight-box strong{
    color: #1e40af;
  }
  
  .print-only{
    display: none;
  }
  
  @media print {
    .app{
      display: block;
      height: auto;
    }
    .tab-nav, #panel, #resultsWrap{
      display: none !important;
    }
    #worksheetView{
      display: block !important;
      max-height: none;
      box-shadow: none;
      grid-row: auto;
    }
    .no-print{
      display: none !important;
    }
    .print-only{
      display: block;
    }
    .worksheet-section{
      page-break-inside: avoid;
    }
  }
  
  .card{
    background:var(--panel); border-radius:var(--radius);
    box-shadow:var(--shadow); overflow:hidden;
  }
  
  #simWrap{ 
    grid-area: sim; 
    display:flex; 
    position:relative;
    min-height: 400px;
  }
  
  #simCanvas{ 
    width:100%; 
    height:100%; 
    display:block; 
    background:linear-gradient(180deg,#dde7f3,#eaf0f7); 
    border-radius:var(--radius);
  }
  
  .hint{
    position:absolute; left:12px; top:12px; font-size:12px; color:#fff;
    background:rgba(0,0,0,0.35); padding:6px 10px; border-radius:10px; backdrop-filter:blur(2px);
  }
  
  .env-overlay{
    position:absolute; right:12px; top:12px; font-size:11px; color:#fff;
    background:rgba(0,0,0,0.5); padding:8px 12px; border-radius:10px; 
    backdrop-filter:blur(2px); max-width: 200px;
  }
  
  .env-overlay div { margin: 3px 0; }
  
  #panel{ 
    grid-area: panel; 
    padding:14px; 
    display:flex; 
    flex-direction:column; 
    gap:12px;
    overflow-y: auto;
    max-height: 100vh;
  }
  
  .panel-section{
    background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:14px; display:flex; flex-direction:column; gap:10px;
  }
  
  .panel-section h3{ margin:0; font-size:16px; }
  .row{ display:flex; align-items:center; gap:10px; }
  .row label{ flex:1; font-size:13px; color:var(--muted);}
  
  input[type="range"]{ width:100%;}
  select, input[type="number"], input[type="text"]{
    width:100%; padding:8px 10px; border:1px solid #e5e7eb; 
    border-radius:10px; outline:none; font-size: 13px;
  }
  
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 12px; border:none; border-radius:12px; cursor:pointer; 
    font-weight:600; font-size: 13px;
    transition:transform .05s ease, box-shadow .2s ease; box-shadow:var(--shadow);
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{ background:var(--accent); color:#fff; }
  .btn.success{ background:var(--accent2); color:#063; }
  .btn.ghost{ background:#f3f4f6; color:#111827;}
  .btn.warn{ background:var(--warn); color:#fff; }
  .btn.info{ background:#8b5cf6; color:#fff; }
  .btn:disabled{ opacity:0.5; cursor:not-allowed; }
  
  .toggle{ display:flex; align-items:center; gap:8px; font-size:13px;}
  .toggle input{ width:18px; height:18px;}
  
  #resultsWrap{ 
    grid-area: results; 
    display:grid; 
    grid-template-columns: 1.5fr 1fr; 
    gap:14px;
  }
  
  @media (max-width: 768px) {
    #resultsWrap {
      grid-template-columns: 1fr;
    }
  }
  
  #barCanvas{ width:100%; height:100%; display:block; border-radius:var(--radius);}
  
  #table{ 
    background:var(--panel); 
    border-radius:var(--radius); 
    box-shadow:var(--shadow); 
    padding:12px; 
    overflow:auto;
    display: flex;
    flex-direction: column;
  }
  
  table{ 
    width:100%; 
    border-collapse:collapse; 
    font-size:12px;
  }
  
  th, td{ 
    border-bottom:1px solid #e5e7eb; 
    padding:8px 6px; 
    text-align:right;
  }
  th:first-child, td:first-child{text-align:left;}
  
  .legend{ display:flex; flex-wrap:wrap; gap:8px; font-size:12px;}
  .badge{ 
    display:inline-flex; 
    align-items:center; 
    gap:6px; 
    background:#f3f4f6; 
    border-radius:999px; 
    padding:4px 10px;
  }
  .dot{ width:10px; height:10px; border-radius:50%;}
  .small{ font-size:12px; color:var(--muted);}
  .sep{ height:1px; background:#e5e7eb; margin:8px 0;}
  
  kbd{ 
    background:#111827; 
    color:#fff; 
    padding:2px 6px; 
    border-radius:6px; 
    font-size:11px;
  }
  
  .help-text{
    font-size: 12px;
    color: var(--muted);
    line-height: 1.5;
    padding: 8px;
    background: #f9fafb;
    border-radius: 8px;
    margin-top: 4px;
  }
  
  .status-bar{
    position: absolute;
    bottom: 12px;
    left: 12px;
    right: 12px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 10px 14px;
    border-radius: 10px;
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
  }
  
  .progress-bar{
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
    margin: 0 12px;
    overflow: hidden;
  }
  
  .progress-fill{
    height: 100%;
    background: var(--accent2);
    transition: width 0.3s ease;
  }
  
  .record-notice{
    background: #fef3c7;
    border: 2px solid #f59e0b;
    padding: 12px;
    border-radius: 10px;
    font-size: 13px;
    margin: 10px 0;
    text-align: center;
    font-weight: 600;
  }
  
  .experiment-log{
    max-height: 200px;
    overflow-y: auto;
    font-size: 12px;
    background: #f9fafb;
    border-radius: 8px;
    padding: 10px;
  }
  
  .log-item{
    padding: 8px;
    margin: 4px 0;
    background: white;
    border-radius: 6px;
    border-left: 3px solid var(--accent2);
  }
  
  .log-item.active{
    background: #dbeafe;
    border-left-color: var(--accent);
  }
</style>
</head>
<body>
<div class="app">
  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('simulation')">ğŸ”¬ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
    <button class="tab-btn" onclick="switchTab('worksheet')">ğŸ“Š å¯¾ç…§å®Ÿé¨“ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆ</button>
    <button class="tab-btn no-print" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
  </div>

  <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– -->
  <div id="simulationTab" class="tab-content active">
    <div id="simWrap" class="card">
      <canvas id="simCanvas"></canvas>
      <div class="hint">
        ã‚¯ãƒªãƒƒã‚¯ï¼šãƒˆãƒ©ãƒƒãƒ—è¨­ç½® | <kbd>Alt</kbd>+ã‚¯ãƒªãƒƒã‚¯ï¼šå‰Šé™¤ | ãƒ‰ãƒ©ãƒƒã‚°ï¼šç§»å‹•
      </div>
      <div class="env-overlay" id="envOverlay" style="display:none;">
        <strong>é¸æŠåœ°ç‚¹ã®ç’°å¢ƒ</strong>
        <div id="envDetail"></div>
      </div>
      <div class="status-bar">
        <span id="timeDisplay">æ™‚é–“: 0.0ç§’ / 60ç§’</span>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <span id="captureDisplay">æ•ç²æ•°: 0åŒ¹</span>
      </div>
    </div>

    <div id="panel">
      <div class="panel-section">
        <h3>ğŸ¯ å¯¾ç…§å®Ÿé¨“ã®æ‰‹é †</h3>
        <div class="help-text">
          <strong>1.</strong> ãƒˆãƒ©ãƒƒãƒ—ã‚’è¨­ç½®ï¼ˆä½ç½®ã‚’æ±ºã‚ã‚‹ï¼‰<br>
          <strong>2.</strong> ç’°å¢ƒã‚’é¸ã‚“ã§å®Ÿé¨“ â†’ è¨˜éŒ²<br>
          <strong>3.</strong> ã€Œå†å®Ÿé¨“ã€ã§ç’°å¢ƒã ã‘å¤‰æ›´<br>
          <strong>4.</strong> ãƒˆãƒ©ãƒƒãƒ—ä½ç½®ã¯åŒã˜ã§åˆ¥ç’°å¢ƒã‚’è©¦ã™<br>
          <strong>5.</strong> çµæœã‚’æ¯”è¼ƒã—ã¦è€ƒå¯Ÿï¼
        </div>
        <div class="record-notice" id="recordNotice" style="display:none;">
          ğŸ“Š å®Ÿé¨“å®Œäº†ï¼ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã‚ˆã†
        </div>
      </div>

      <div class="panel-section">
        <h3>âš™ï¸ åŸºæœ¬æ“ä½œ</h3>
        <div class="row" style="gap:8px;">
          <button id="playBtn" class="btn primary">â–¶ å†ç”Ÿ</button>
          <button id="stepBtn" class="btn ghost">â± +1ç§’</button>
        </div>
        <div class="row" style="gap:8px; margin-top:8px;">
          <button id="rerunBtn" class="btn info">ğŸ”„ å†å®Ÿé¨“<br><span style="font-size:10px;">(ãƒˆãƒ©ãƒƒãƒ—ä¿æŒ)</span></button>
          <button id="resetBtn" class="btn warn">â†º å…¨ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="row">
          <label>ä»®æƒ³æ™‚é–“ã®é€Ÿã•</label>
          <input id="speed" type="range" min="0.5" max="4" step="0.25" value="2">
          <span id="speedVal">2.00Ã—</span>
        </div>
        <div class="row">
          <label>è¦³å¯Ÿæ™‚é–“ï¼ˆç§’ï¼‰</label>
          <input id="duration" type="range" min="10" max="240" step="10" value="60">
          <span id="durVal">60</span>
        </div>
        <div class="toggle">
          <input id="showAgents" type="checkbox" checked>
          <span>å€‹ä½“ã®å‹•ãã‚’è¡¨ç¤º</span>
        </div>
      </div>

      <div class="panel-section">
        <h3>ğŸŒ² ç’°å¢ƒãƒ—ãƒªã‚»ãƒƒãƒˆ</h3>
        <select id="preset">
          <option value="forest">æ—å†…ï¼ˆæ¹¿ã‚Šâ†‘ãƒ»è½è‘‰â†‘ãƒ»å…‰â†“ï¼‰</option>
          <option value="edge">æ—ç¸ï¼ˆç’°å¢ƒã®ãƒ ãƒ©å¤§ï¼‰</option>
          <option value="meadow">è‰åœ°ï¼ˆå…‰â†‘ãƒ»è½è‘‰â†“ï¼‰</option>
          <option value="shade">æœ¨é™°ï¼ˆå…‰â†“ãƒ»æ¹¿ã‚Šâ†‘ï¼‰</option>
          <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
        </select>
        <div class="row">
          <label>ğŸ’§ æ¹¿ã‚Šæ°—</label>
          <input id="moist" type="range" min="0" max="1" step="0.01" value="0.7">
          <span id="moistVal">0.70</span>
        </div>
        <div class="row">
          <label>ğŸ‚ è½ã¡è‘‰é‡</label>
          <input id="litter" type="range" min="0" max="1" step="0.01" value="0.7">
          <span id="litterVal">0.70</span>
        </div>
        <div class="row">
          <label>â˜€ï¸ å…‰</label>
          <input id="light" type="range" min="0" max="1" step="0.01" value="0.3">
          <span id="lightVal">0.30</span>
        </div>
      </div>

      <div class="panel-section">
        <h3>ğŸ› ç¨®ã¨å€‹ä½“æ•°</h3>
        <div id="legend" class="legend"></div>
        <div class="row">
          <label>å„ç¨®ã®åˆæœŸå€‹ä½“æ•°</label>
          <input id="density" type="range" min="50" max="600" step="10" value="400">
          <span id="densVal">400</span>
        </div>
        <div class="row">
          <label>é¤Œã®èª˜å¼•åŠ¹æœ</label>
          <input id="bait" type="range" min="0" max="1.5" step="0.05" value="0.3">
          <span id="baitVal">0.30</span>
        </div>
        <div class="row">
          <label>ãƒˆãƒ©ãƒƒãƒ—å£å¾„ï¼ˆpxï¼‰</label>
          <input id="trapR" type="range" min="8" max="40" step="1" value="18">
          <span id="trapRVal">18</span>
        </div>
        <div class="row" style="gap:8px;">
          <button id="clearTrap" class="btn ghost">ğŸ—‘ ãƒˆãƒ©ãƒƒãƒ—æ¶ˆå»</button>
          <button id="autoTrap" class="btn success">ï¼‹ è‡ªå‹•4ç‚¹</button>
        </div>
      </div>

      <div class="panel-section">
        <h3>ğŸ“Š å®Ÿé¨“è¨˜éŒ²</h3>
        <button id="recordBtn" class="btn success" style="width:100%; margin-bottom:8px;">
          ğŸ’¾ ç¾åœ¨ã®çµæœã‚’è¨˜éŒ²
        </button>
        <div class="experiment-log" id="experimentLog">
          <div class="small" style="text-align:center; color:var(--muted);">è¨˜éŒ²ã•ã‚ŒãŸå®Ÿé¨“ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        </div>
        <button id="fillWorksheetBtn" class="btn info" style="width:100%; margin-top:8px;">
          ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã«è»¢è¨˜
        </button>
      </div>
    </div>

    <div id="resultsWrap">
      <div class="card" style="padding:12px;">
        <strong style="font-size:14px;">ğŸ“Š ç¨®åˆ¥ã”ã¨ã®æ•ç²æ•°</strong>
        <canvas id="barCanvas"></canvas>
      </div>
      <div id="table" class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
          <strong>ãƒˆãƒ©ãƒƒãƒ—åˆ¥ã®çµæœ</strong>
        </div>
        <div style="flex:1; overflow:auto;">
          <table id="trapTable">
            <thead>
              <tr>
                <th>#</th>
                <th>ã‚´ãƒ¢ã‚¯</th>
                <th>ã‚·ãƒ‡ãƒ ã‚·</th>
                <th>ã‚¢ãƒª</th>
                <th>ãƒ€ãƒ³ã‚´</th>
                <th>åˆè¨ˆ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã‚¿ãƒ– -->
  <div id="worksheetTab" class="tab-content">
    <div id="worksheetView">
      <div class="worksheet-header">
        <h1>åœ°è¡¨å¾˜å¾Šæ€§ç”Ÿç‰©ã¨ç’°å¢ƒè¦å› ã®é–¢ä¿‚ã‚’èª¿ã¹ã‚‹å¯¾ç…§å®Ÿé¨“</h1>
        <div style="font-size:14px; margin-top:10px;">ï½ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æ¢ç©¶æ´»å‹•ï½</div>
        <div class="print-only" style="margin-top:15px; font-size:13px;">
          å¹´ã€€ã€€çµ„ã€€ã€€ç•ªã€€æ°åï¼šã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€
        </div>
      </div>

      <div class="worksheet-section">
        <h2>ã€æ¢ç©¶ã®å•ã„ã€‘</h2>
        <p style="font-size:16px; font-weight:600;">
          ç’°å¢ƒæ¡ä»¶ï¼ˆæ¹¿ã‚Šæ°—ãƒ»è½ã¡è‘‰é‡ãƒ»å…‰ï¼‰ã‚’å¤‰ãˆã‚‹ã¨ã€åœ°è¡¨å¾˜å¾Šæ€§ç”Ÿç‰©ã®æ•ç²æ•°ã¯ã©ã®ã‚ˆã†ã«å¤‰åŒ–ã™ã‚‹ã ã‚ã†ã‹ï¼Ÿ
        </p>
      </div>

      <div class="worksheet-section">
        <h2>ã€ä»®èª¬ã€‘</h2>
        <p>å„ç’°å¢ƒï¼ˆæ—å†…ãƒ»è‰åœ°ãƒ»æ—ç¸ãƒ»æœ¨é™°ï¼‰ã§ã€ã©ã®ç¨®ãŒå¤šãæ•ç²ã•ã‚Œã‚‹ã¨äºˆæƒ³ã™ã‚‹ã‹ï¼Ÿã¾ãŸãã®ç†ç”±ã¯ï¼Ÿ</p>
        <div class="input-area">
          <textarea id="hypothesis" placeholder="ä¾‹ï¼šæ—å†…ï¼ˆæ¹¿ã‚Šâ†‘ãƒ»è½è‘‰â†‘ãƒ»å…‰â†“ï¼‰ã§ã¯ã€æ¹¿ã£ãŸæš—ã„ç’°å¢ƒã‚’å¥½ã‚€ç¨®ãŒå¤šãæ•ç²ã•ã‚Œã‚‹ã¨äºˆæƒ³ã™ã‚‹ã€‚ãªãœãªã‚‰..."></textarea>
        </div>
      </div>

      <div class="worksheet-section">
        <h2>ã€å®Ÿé¨“æ–¹æ³•ã€‘</h2>
        <div class="highlight-box">
          <strong>âš ï¸ é‡è¦ï¼šå¯¾ç…§å®Ÿé¨“ã®æ¡ä»¶</strong>
          <ul style="margin:10px 0; padding-left:20px;">
            <li><strong>ç‹¬ç«‹å¤‰æ•°</strong>ï¼ˆå¤‰ãˆã‚‹æ¡ä»¶ï¼‰ï¼šç’°å¢ƒæ¡ä»¶ï¼ˆæ¹¿ã‚Šãƒ»è½è‘‰ãƒ»å…‰ï¼‰</li>
            <li><strong>å¾“å±å¤‰æ•°</strong>ï¼ˆæ¸¬å®šã™ã‚‹å€¤ï¼‰ï¼šå„ç¨®ã®æ•ç²æ•°</li>
            <li><strong>åˆ¶å¾¡å¤‰æ•°</strong>ï¼ˆå›ºå®šã™ã‚‹æ¡ä»¶ï¼‰ï¼š<br>
              ãƒ»ãƒˆãƒ©ãƒƒãƒ—ã®ä½ç½®ï¼ˆ4ç®‡æ‰€ã«å›ºå®šï¼‰<br>
              ãƒ»è¦³å¯Ÿæ™‚é–“ï¼ˆ60ç§’ï¼‰<br>
              ãƒ»é¤Œã®èª˜å¼•åŠ¹æœ<br>
              ãƒ»å„ç¨®ã®åˆæœŸå€‹ä½“æ•°
            </li>
          </ul>
        </div>
        
        <h3>æ‰‹é †</h3>
        <ol>
          <li>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒˆãƒ©ãƒƒãƒ—ã‚’4ç®‡æ‰€ã«è¨­ç½®ã™ã‚‹</li>
          <li>ç’°å¢ƒãƒ—ãƒªã‚»ãƒƒãƒˆã€Œæ—å†…ã€ã‚’é¸æŠã—ã€å®Ÿé¨“ã‚’å®Ÿæ–½ã™ã‚‹</li>
          <li>å„ç¨®ã®æ•ç²æ•°ï¼ˆåˆè¨ˆï¼‰ã‚’ä¸‹è¡¨ã«è¨˜éŒ²ã™ã‚‹</li>
          <li><strong>ã€Œå†å®Ÿé¨“ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</strong>ï¼ˆãƒˆãƒ©ãƒƒãƒ—ã®ä½ç½®ã¯ãã®ã¾ã¾ï¼‰</li>
          <li>ç’°å¢ƒãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ã€Œè‰åœ°ã€ã«å¤‰æ›´ã—ã€å®Ÿé¨“ã‚’å®Ÿæ–½ã™ã‚‹</li>
          <li>åŒæ§˜ã«è¨˜éŒ²ã™ã‚‹</li>
          <li>ã€Œæ—ç¸ã€ã€Œæœ¨é™°ã€ã§ã‚‚å®Ÿæ–½ã—ã€å…¨ã¦ã®ç’°å¢ƒã§ã®çµæœã‚’æ¯”è¼ƒã™ã‚‹</li>
        </ol>
      </div>

      <div class="worksheet-section">
        <h2>ã€å®Ÿé¨“çµæœã€‘</h2>
        <p><strong>â€» ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€Œãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã«è»¢è¨˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™</strong></p>
        
        <table class="comparison-table">
          <thead>
            <tr>
              <th rowspan="2">ç’°å¢ƒæ¡ä»¶</th>
              <th colspan="3">ç’°å¢ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</th>
              <th colspan="4">å„ç¨®ã®æ•ç²æ•°ï¼ˆåˆè¨ˆï¼‰</th>
              <th rowspan="2">ç·æ•ç²æ•°</th>
            </tr>
            <tr>
              <th>æ¹¿ã‚Š</th>
              <th>è½è‘‰</th>
              <th>å…‰</th>
              <th>ã‚´ãƒ¢ã‚¯</th>
              <th>ã‚·ãƒ‡ãƒ ã‚·</th>
              <th>ã‚¢ãƒª</th>
              <th>ãƒ€ãƒ³ã‚´</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>æ—å†…</td>
              <td class="env-values">0.75</td>
              <td class="env-values">0.75</td>
              <td class="env-values">0.25</td>
              <td><input type="number" id="forest_carabid" min="0" value="0"></td>
              <td><input type="number" id="forest_silphid" min="0" value="0"></td>
              <td><input type="number" id="forest_ant" min="0" value="0"></td>
              <td><input type="number" id="forest_pillbug" min="0" value="0"></td>
              <td id="forest_total">0</td>
            </tr>
            <tr>
              <td>è‰åœ°</td>
              <td class="env-values">0.35</td>
              <td class="env-values">0.25</td>
              <td class="env-values">0.80</td>
              <td><input type="number" id="meadow_carabid" min="0" value="0"></td>
              <td><input type="number" id="meadow_silphid" min="0" value="0"></td>
              <td><input type="number" id="meadow_ant" min="0" value="0"></td>
              <td><input type="number" id="meadow_pillbug" min="0" value="0"></td>
              <td id="meadow_total">0</td>
            </tr>
            <tr>
              <td>æ—ç¸</td>
              <td class="env-values">0.55</td>
              <td class="env-values">0.55</td>
              <td class="env-values">0.55</td>
              <td><input type="number" id="edge_carabid" min="0" value="0"></td>
              <td><input type="number" id="edge_silphid" min="0" value="0"></td>
              <td><input type="number" id="edge_ant" min="0" value="0"></td>
              <td><input type="number" id="edge_pillbug" min="0" value="0"></td>
              <td id="edge_total">0</td>
            </tr>
            <tr>
              <td>æœ¨é™°</td>
              <td class="env-values">0.65</td>
              <td class="env-values">0.55</td>
              <td class="env-values">0.25</td>
              <td><input type="number" id="shade_carabid" min="0" value="0"></td>
              <td><input type="number" id="shade_silphid" min="0" value="0"></td>
              <td><input type="number" id="shade_ant" min="0" value="0"></td>
              <td><input type="number" id="shade_pillbug" min="0" value="0"></td>
              <td id="shade_total">0</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="worksheet-section">
        <h2>ã€è€ƒå¯Ÿã€‘</h2>
        
        <h3>1. ä»®èª¬ã®æ¤œè¨¼</h3>
        <p>å®Ÿé¨“çµæœã¯ä»®èª¬ã¨ä¸€è‡´ã—ãŸã‹ï¼Ÿä¸€è‡´ã—ãªã‹ã£ãŸéƒ¨åˆ†ãŒã‚ã‚Œã°ã€ãã®ç†ç”±ã‚’è€ƒãˆã‚ˆã†ã€‚</p>
        <div class="input-area">
          <textarea id="discussion1" placeholder="ä»®èª¬ã¨çµæœã‚’æ¯”è¼ƒã—ã¦è¨˜è¿°..."></textarea>
        </div>

        <h3>2. å„ç¨®ã¨ç’°å¢ƒã®é–¢ä¿‚ï¼ˆç’°å¢ƒå—œå¥½ã®ç™ºè¦‹ï¼‰</h3>
        <p>å„ç¨®ã«ã¤ã„ã¦ã€ã©ã®ã‚ˆã†ãªç’°å¢ƒæ¡ä»¶ã§æ•ç²æ•°ãŒå¤šã‹ã£ãŸã‹ï¼Ÿå®Ÿé¨“çµæœã‹ã‚‰ã€å„ç¨®ãŒã©ã®ã‚ˆã†ãªç’°å¢ƒã‚’å¥½ã‚€ã¨è€ƒãˆã‚‰ã‚Œã‚‹ã‹ï¼Ÿ</p>
        <div class="input-area">
          <textarea id="discussion2" placeholder="ç¨®ã”ã¨ã«ã€ã©ã®ç’°å¢ƒã§å¤šãæ•ç²ã•ã‚ŒãŸã‹ã‚’åˆ†æã—ã€å„ç¨®ã®ç’°å¢ƒå—œå¥½ã‚’æ¨æ¸¬ã—ã¦ã¿ã‚ˆã†...&#10;&#10;ä¾‹ï¼š&#10;ãƒ»ã‚´ãƒ¢ã‚¯ãƒ ã‚·é¡ã¯æ—å†…ã§æœ€ã‚‚å¤šãæ•ç²ã•ã‚ŒãŸã®ã§ã€æ¹¿ã£ãŸæš—ã„ç’°å¢ƒã‚’å¥½ã‚€ã¨è€ƒãˆã‚‰ã‚Œã‚‹ã€‚&#10;ãƒ»ã‚¯ãƒ­ãƒ¤ãƒã‚¢ãƒªã¯è‰åœ°ã§..."></textarea>
        </div>

        <h3>3. ãƒˆãƒ©ãƒƒãƒ—ä½ç½®ã‚’å›ºå®šã™ã‚‹æ„ç¾©</h3>
        <p>ä»Šå›ã®å®Ÿé¨“ã§ã¯ã€ãªãœãƒˆãƒ©ãƒƒãƒ—ã®ä½ç½®ã‚’å¤‰ãˆãšã«ç’°å¢ƒã ã‘ã‚’å¤‰ãˆãŸã®ã‹ï¼Ÿãã®ç§‘å­¦çš„æ„ç¾©ã‚’èª¬æ˜ã—ã‚ˆã†ã€‚</p>
        <div class="input-area">
          <textarea id="discussion3" placeholder="å¯¾ç…§å®Ÿé¨“ã«ãŠã‘ã‚‹åˆ¶å¾¡å¤‰æ•°ã®é‡è¦æ€§ã«ã¤ã„ã¦..."></textarea>
        </div>

        <h3>4. ç™ºå±•çš„è€ƒå¯Ÿ</h3>
        <p>æ¬¡ã®ã‚ˆã†ãªè¦å› ã¯ã€å®Ÿé¨“çµæœã«ã©ã®ã‚ˆã†ãªå½±éŸ¿ã‚’ä¸ãˆã‚‹ã¨è€ƒãˆã‚‰ã‚Œã‚‹ã‹ï¼Ÿ</p>
        <ul>
          <li>é¤Œã®èª˜å¼•åŠ¹æœã‚’å¼·ãã—ãŸå ´åˆã€ç’°å¢ƒã«ã‚ˆã‚‹é•ã„ã¯ã©ã†ãªã‚‹ã‹ï¼Ÿ</li>
          <li>è¦³å¯Ÿæ™‚é–“ã‚’å¤‰æ›´ã—ãŸå ´åˆã€çµæœã¯ã©ã†å¤‰ã‚ã‚‹ã‹ï¼Ÿ</li>
          <li>åŒã˜ç’°å¢ƒã§è¤‡æ•°å›è©¦è¡Œã—ãŸå ´åˆã€çµæœã¯ã©ã‚Œãã‚‰ã„ã°ã‚‰ã¤ãã‹ï¼Ÿ</li>
          <li>å®Ÿéš›ã®é‡å¤–èª¿æŸ»ã§ãƒ”ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒˆãƒ©ãƒƒãƒ—ã‚’ä½¿ã†éš›ã®æ³¨æ„ç‚¹ã¯ï¼Ÿ</li>
        </ul>
        <div class="input-area">
          <textarea id="discussion4" placeholder="å®Ÿé¨“æ¡ä»¶ã®å¤‰æ›´ãŒçµæœã«ä¸ãˆã‚‹å½±éŸ¿ã‚’è€ƒå¯Ÿ..."></textarea>
        </div>
      </div>

      <div class="worksheet-section">
        <h2>ã€ã¾ã¨ã‚ã€‘</h2>
        <p>ã“ã®å®Ÿé¨“ã‚’é€šã—ã¦åˆ†ã‹ã£ãŸã“ã¨ã‚’ã€ã€Œç’°å¢ƒã¨ç”Ÿç‰©ã®é–¢ä¿‚ã€ã¨ã„ã†è¦–ç‚¹ã§ã¾ã¨ã‚ã‚ˆã†ã€‚å„ç¨®ã¯ã©ã®ã‚ˆã†ãªç’°å¢ƒã«é©å¿œã—ã¦ã„ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã‚‹ã‹ï¼Ÿ</p>
        <div class="input-area">
          <textarea id="summary" placeholder="å®Ÿé¨“å…¨ä½“ã®ã¾ã¨ã‚..." style="min-height:100px;"></textarea>
        </div>
      </div>

      <div class="worksheet-section print-only">
        <h3>ã€è‡ªå·±è©•ä¾¡ã€‘</h3>
        <table class="comparison-table">
          <tr>
            <td style="text-align:left;">å¯¾ç…§å®Ÿé¨“ã®æ–¹æ³•ã‚’ç†è§£ã§ããŸ</td>
            <td style="text-align:center;">Aã€€ã€€Bã€€ã€€C</td>
          </tr>
          <tr>
            <td style="text-align:left;">ç’°å¢ƒã¨ç”Ÿç‰©ã®é–¢ä¿‚ã«ã¤ã„ã¦è€ƒå¯Ÿã§ããŸ</td>
            <td style="text-align:center;">Aã€€ã€€Bã€€ã€€C</td>
          </tr>
          <tr>
            <td style="text-align:left;">ç©æ¥µçš„ã«æ¢ç©¶æ´»å‹•ã«å–ã‚Šçµ„ã‚ãŸ</td>
            <td style="text-align:center;">Aã€€ã€€Bã€€ã€€C</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   åœ°è¡¨å¾˜å¾Šç”Ÿç‰©ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ - å¯¾ç…§å®Ÿé¨“ç‰ˆ
   ========================================================= */

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchTab(tabName) {
  const tabs = document.querySelectorAll('.tab-content');
  const btns = document.querySelectorAll('.tab-btn');
  
  tabs.forEach(tab => tab.classList.remove('active'));
  btns.forEach(btn => btn.classList.remove('active'));
  
  if(tabName === 'simulation') {
    document.getElementById('simulationTab').classList.add('active');
    btns[0].classList.add('active');
  } else if(tabName === 'worksheet') {
    document.getElementById('worksheetTab').classList.add('active');
    btns[1].classList.add('active');
  }
}

// å®Ÿé¨“è¨˜éŒ²ã®ä¿å­˜
let experimentRecords = [];

function recordExperiment() {
  if(traps.length === 0) {
    alert('ãƒˆãƒ©ãƒƒãƒ—ãŒè¨­ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }
  
  if(elapsed < targetDuration * 0.9) {
    if(!confirm('è¦³å¯Ÿæ™‚é–“ãŒååˆ†ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
  }
  
  const presetNames = {
    'forest': 'æ—å†…',
    'edge': 'æ—ç¸',
    'meadow': 'è‰åœ°',
    'shade': 'æœ¨é™°',
    'custom': 'ã‚«ã‚¹ã‚¿ãƒ '
  };
  
  const sum = totalBySpecies();
  const record = {
    timestamp: new Date().toLocaleString('ja-JP', {hour: '2-digit', minute: '2-digit'}),
    preset: ui.preset.value,
    presetName: presetNames[ui.preset.value] || 'ã‚«ã‚¹ã‚¿ãƒ ',
    env: {
      moist: +ui.moist.value,
      litter: +ui.litter.value,
      light: +ui.light.value
    },
    trapCount: traps.length,
    counts: {...sum},
    total: Object.values(sum).reduce((a,b) => a+b, 0)
  };
  
  experimentRecords.push(record);
  updateExperimentLog();
  
  ui.recordNotice.style.display = 'block';
  setTimeout(() => {
    ui.recordNotice.style.display = 'none';
  }, 3000);
}

function updateExperimentLog() {
  const log = document.getElementById('experimentLog');
  
  if(experimentRecords.length === 0) {
    log.innerHTML = '<div class="small" style="text-align:center; color:var(--muted);">è¨˜éŒ²ã•ã‚ŒãŸå®Ÿé¨“ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  log.innerHTML = '';
  experimentRecords.forEach((rec, idx) => {
    const div = document.createElement('div');
    div.className = 'log-item';
    if(idx === experimentRecords.length - 1) div.classList.add('active');
    
    div.innerHTML = `
      <div style="font-weight:600; margin-bottom:4px;">${rec.presetName} - ${rec.timestamp}</div>
      <div class="small">
        æ¹¿${(rec.env.moist*100).toFixed(0)} è‘‰${(rec.env.litter*100).toFixed(0)} å…‰${(rec.env.light*100).toFixed(0)} | 
        ã‚´:${rec.counts.carabid} ã‚·:${rec.counts.silphid} ã‚¢:${rec.counts.ant} ãƒ€:${rec.counts.pillbug}
      </div>
    `;
    
    log.appendChild(div);
  });
  
  log.scrollTop = log.scrollHeight;
}

function fillWorksheetFromRecords() {
  if(experimentRecords.length === 0) {
    alert('è¨˜éŒ²ã•ã‚ŒãŸå®Ÿé¨“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿæ–½ã—ã¦è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  
  const presetMap = {
    'forest': 'forest',
    'meadow': 'meadow',
    'edge': 'edge',
    'shade': 'shade'
  };
  
  experimentRecords.forEach(rec => {
    const presetKey = presetMap[rec.preset];
    if(!presetKey) return;
    
    document.getElementById(`${presetKey}_carabid`).value = rec.counts.carabid || 0;
    document.getElementById(`${presetKey}_silphid`).value = rec.counts.silphid || 0;
    document.getElementById(`${presetKey}_ant`).value = rec.counts.ant || 0;
    document.getElementById(`${presetKey}_pillbug`).value = rec.counts.pillbug || 0;
    
    updateRowTotal(presetKey);
  });
  
  alert('ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã«å®Ÿé¨“çµæœã‚’è»¢è¨˜ã—ã¾ã—ãŸï¼');
  switchTab('worksheet');
}

function updateRowTotal(preset) {
  const carabid = +document.getElementById(`${preset}_carabid`).value || 0;
  const silphid = +document.getElementById(`${preset}_silphid`).value || 0;
  const ant = +document.getElementById(`${preset}_ant`).value || 0;
  const pillbug = +document.getElementById(`${preset}_pillbug`).value || 0;
  
  document.getElementById(`${preset}_total`).textContent = carabid + silphid + ant + pillbug;
}

// å…¨ã¦ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
['forest', 'meadow', 'edge', 'shade'].forEach(preset => {
  ['carabid', 'silphid', 'ant', 'pillbug'].forEach(species => {
    const elem = document.getElementById(`${preset}_${species}`);
    if(elem) {
      elem.addEventListener('input', () => updateRowTotal(preset));
    }
  });
});

// ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
const simCanvas = document.getElementById('simCanvas');
const barCanvas = document.getElementById('barCanvas');
const ctx = simCanvas.getContext('2d');
const gctx = barCanvas.getContext('2d');

function fitCanvas(cnv){
  const rect = cnv.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  cnv.width = Math.floor(rect.width * dpr);
  cnv.height = Math.floor(rect.height * dpr);
  const c = cnv.getContext('2d');
  c.setTransform(dpr,0,0,dpr,0,0);
}

function resizeAll(){ 
  fitCanvas(simCanvas); 
  fitCanvas(barCanvas); 
  if(env) regenEnv();
  draw(0); 
  drawBar(); 
}
window.addEventListener('resize', resizeAll);

// ç¨®ã®å®šç¾©ï¼ˆç’°å¢ƒå—œå¥½ã‚’å¼·åŒ–ï¼‰
const species = [
  { key:'carabid', name:'ã‚´ãƒ¢ã‚¯ãƒ ã‚·é¡', shortName:'ã‚´ãƒ¢ã‚¯', color:'#2563eb', 
    pref:{moist: +2.0, litter:+1.8, light:-1.5}, speed:60 },
  { key:'silphid', name:'ã‚ªã‚ªãƒ’ãƒ©ã‚¿ã‚·ãƒ‡ãƒ ã‚·', shortName:'ã‚·ãƒ‡ãƒ ã‚·', color:'#7c3aed', 
    pref:{moist: +1.5, litter:+2.0, light:-1.8}, speed:50 },
  { key:'ant', name:'ã‚¯ãƒ­ãƒ¤ãƒã‚¢ãƒª', shortName:'ã‚¢ãƒª', color:'#111827', 
    pref:{moist: +0.3, litter:+0.2, light:+0.5}, speed:80 },
  { key:'pillbug', name:'ã‚ªã‚«ãƒ€ãƒ³ã‚´ãƒ ã‚·', shortName:'ãƒ€ãƒ³ã‚´', color:'#10b981', 
    pref:{moist: +2.5, litter:+1.5, light:-1.2}, speed:40 },
];

const legendDiv = document.getElementById('legend');
species.forEach(s=>{
  const b = document.createElement('div'); 
  b.className='badge';
  const d = document.createElement('div'); 
  d.className='dot'; 
  d.style.background=s.color;
  b.appendChild(d); 
  b.appendChild(document.createTextNode(s.name));
  legendDiv.appendChild(b);
});

// UIè¦ç´ 
const ui = {
  play: document.getElementById('playBtn'),
  step: document.getElementById('stepBtn'),
  rerun: document.getElementById('rerunBtn'),
  reset: document.getElementById('resetBtn'),
  speed: document.getElementById('speed'),
  speedVal: document.getElementById('speedVal'),
  duration: document.getElementById('duration'),
  durVal: document.getElementById('durVal'),
  showAgents: document.getElementById('showAgents'),
  preset: document.getElementById('preset'),
  moist: document.getElementById('moist'),
  moistVal: document.getElementById('moistVal'),
  litter: document.getElementById('litter'),
  litterVal: document.getElementById('litterVal'),
  light: document.getElementById('light'),
  lightVal: document.getElementById('lightVal'),
  density: document.getElementById('density'),
  densVal: document.getElementById('densVal'),
  bait: document.getElementById('bait'),
  baitVal: document.getElementById('baitVal'),
  trapR: document.getElementById('trapR'),
  trapRVal: document.getElementById('trapRVal'),
  clearTrap: document.getElementById('clearTrap'),
  autoTrap: document.getElementById('autoTrap'),
  tableBody: document.querySelector('#trapTable tbody'),
  timeDisplay: document.getElementById('timeDisplay'),
  captureDisplay: document.getElementById('captureDisplay'),
  progressFill: document.getElementById('progressFill'),
  recordBtn: document.getElementById('recordBtn'),
  fillWorksheetBtn: document.getElementById('fillWorksheetBtn'),
  recordNotice: document.getElementById('recordNotice'),
  envOverlay: document.getElementById('envOverlay'),
  envDetail: document.getElementById('envDetail'),
};

let env = null;
let traps = [];
let agents = [];
let running = false;
let elapsed = 0;
let targetDuration = 60;
let rng = mulberry32(12345);

function mulberry32(a) {
  return function() {
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}

function perlinNoise2D(x, y, scale=0.05){
  const X = Math.floor(x*scale), Y = Math.floor(y*scale);
  const xf = x*scale - X, yf = y*scale - Y;
  const fade = t => t*t*t*(t*(t*6-15)+10);
  const lerp = (a,b,t) => a + t*(b-a);
  const grad = (h,x,y) => {
    const v = (h&1) ? x : y;
    return ((h&2) ? -v : v);
  };
  const hash = (i,j) => {
    let h = i*374761393 + j*668265263;
    h = (h^(h>>>13))*1274126177;
    return (h^(h>>>16))&3;
  };
  const a = grad(hash(X,Y), xf, yf);
  const b = grad(hash(X+1,Y), xf-1, yf);
  const c = grad(hash(X,Y+1), xf, yf-1);
  const d = grad(hash(X+1,Y+1), xf-1, yf-1);
  const u = fade(xf), v = fade(yf);
  return lerp(lerp(a,b,u), lerp(c,d,u), v);
}

function makeField(w, h, moistBase, litterBase, lightBase){
  const data = [];
  for(let y=0; y<h; y++){
    for(let x=0; x<w; x++){
      const n1 = perlinNoise2D(x,y,0.02)*0.3;
      const n2 = perlinNoise2D(x,y,0.05)*0.2;
      const n3 = perlinNoise2D(x+1000,y+1000,0.03)*0.15;
      const moist = Math.max(0, Math.min(1, moistBase + n1));
      const litter = Math.max(0, Math.min(1, litterBase + n2));
      const light = Math.max(0, Math.min(1, lightBase + n3));
      data.push({moist, litter, light});
    }
  }
  return {w, h, data};
}

function getEnv(x,y){
  if(!env) return {moist:0.5, litter:0.5, light:0.5};
  const ix = Math.floor(y)*env.w + Math.floor(x);
  if(ix<0 || ix>=env.data.length) return {moist:0.5, litter:0.5, light:0.5};
  return env.data[ix];
}

function initAgents(total){
  agents = [];
  const perSpecies = Math.floor(total / species.length);
  for(let s=0; s<species.length; s++){
    for(let i=0; i<perSpecies; i++){
      agents.push({
        x: rng()*simCanvas.width,
        y: rng()*simCanvas.height,
        s: s,
        alive: true
      });
    }
  }
}

function addTrap(x, y){
  const r = +ui.trapR.value;
  const e = getEnv(x, y);
  traps.push({
    x, y, r,
    env: e,
    count: species.reduce((o,sp)=>{o[sp.key]=0; return o;}, {})
  });
  updateTrapTable();
}

function clearTraps(){
  traps = [];
  updateTrapTable();
  draw();
}

function autoPlaceTraps(){
  const w = simCanvas.width, h = simCanvas.height;
  const positions = [
    {x: w*0.25, y: h*0.25},
    {x: w*0.75, y: h*0.25},
    {x: w*0.25, y: h*0.75},
    {x: w*0.75, y: h*0.75}
  ];
  positions.forEach(p => addTrap(p.x, p.y));
  draw();
}

function removeNearestTrap(x, y){
  let best = -1, minD = Infinity;
  for(let i=0; i<traps.length; i++){
    const d = (traps[i].x-x)**2 + (traps[i].y-y)**2;
    if(d < minD){ minD=d; best=i; }
  }
  if(best>=0 && minD < 1600){
    traps.splice(best, 1);
    updateTrapTable();
  }
}

function update(dt){
  elapsed += dt;
  
  if(elapsed >= targetDuration){
    running = false;
    ui.play.textContent = 'â–¶ å†ç”Ÿ';
    updateStatus();
    return;
  }
  
  updateStatus();
  
  const baitStrength = +ui.bait.value;
  
  for(const a of agents){
    if(!a.alive) continue;
    
    const sp = species[a.s];
    const candidates = [];
    
    for(let dy=-1; dy<=1; dy++){
      for(let dx=-1; dx<=1; dx++){
        if(dx===0 && dy===0) continue;
        const nx = a.x + dx * sp.speed * dt;
        const ny = a.y + dy * sp.speed * dt;
        
        if(nx<0 || nx>=simCanvas.width || ny<0 || ny>=simCanvas.height) continue;
        
        const e = getEnv(nx, ny);
        
        let score = sp.pref.moist * e.moist 
                  + sp.pref.litter * e.litter 
                  + sp.pref.light * e.light;
        
        for(const t of traps){
          const dist = Math.sqrt((t.x-nx)**2 + (t.y-ny)**2);
          if(dist < 200){
            score += baitStrength * (200-dist)/200;
          }
        }
        
        candidates.push({x:nx, y:ny, score});
      }
    }
    
    if(candidates.length === 0) continue;
    
    const maxScore = Math.max(...candidates.map(c=>c.score));
    const weights = candidates.map(c => Math.exp((c.score - maxScore)*4));
    const sumW = weights.reduce((a,b)=>a+b, 0);
    
    let r = rng() * sumW;
    let chosen = candidates[0];
    for(let i=0; i<candidates.length; i++){
      r -= weights[i];
      if(r <= 0){ chosen = candidates[i]; break; }
    }
    
    a.x = chosen.x;
    a.y = chosen.y;
    
    for(const t of traps){
      const d = Math.sqrt((t.x-a.x)**2 + (t.y-a.y)**2);
      if(d <= t.r){
        a.alive = false;
        t.count[sp.key]++;
        break;
      }
    }
  }
}

function updateStatus(){
  const totalCaptured = agents.filter(a => !a.alive).length;
  ui.timeDisplay.textContent = `æ™‚é–“: ${elapsed.toFixed(1)}ç§’ / ${targetDuration}ç§’`;
  ui.captureDisplay.textContent = `æ•ç²æ•°: ${totalCaptured}åŒ¹`;
  const progress = Math.min(100, (elapsed / targetDuration) * 100);
  ui.progressFill.style.width = progress + '%';
}

function draw(){
  const W = simCanvas.width, H = simCanvas.height;
  ctx.clearRect(0, 0, W, H);
  
  if(!env) return;
  
  const img = ctx.createImageData(W, H);
  for(let y=0; y<H; y+=2){
    for(let x=0; x<W; x+=2){
      const e = getEnv(x, y);
      
      let r = 200 + e.light*40 - e.moist*30;
      let g = 210 + e.light*30 - e.litter*40;
      let b = 220 - e.litter*50 + e.moist*20;
      
      r = Math.max(0, Math.min(255, r));
      g = Math.max(0, Math.min(255, g));
      b = Math.max(0, Math.min(255, b));
      
      for(let dy=0; dy<2; dy++){
        for(let dx=0; dx<2; dx++){
          const ix = ((y+dy)*W + (x+dx)) * 4;
          img.data[ix]=r; 
          img.data[ix+1]=g; 
          img.data[ix+2]=b; 
          img.data[ix+3]=255;
        }
      }
    }
  }
  ctx.putImageData(img, 0, 0);
  
  for(let i=0; i<traps.length; i++){
    const t = traps[i];
    ctx.save();
    ctx.beginPath(); 
    ctx.arc(t.x, t.y, t.r, 0, Math.PI*2);
    ctx.fillStyle='rgba(16,185,129,0.18)';
    ctx.fill();
    ctx.lineWidth=2; 
    ctx.strokeStyle='rgba(16,185,129,0.9)'; 
    ctx.stroke();
    ctx.font='bold 12px system-ui'; 
    ctx.fillStyle='rgba(0,0,0,0.8)';
    ctx.fillText(`#${i+1}`, t.x - 8, t.y - t.r - 8);
    ctx.restore();
  }
  
  if(ui.showAgents.checked){
    for(const a of agents){
      if(!a.alive) continue;
      ctx.beginPath();
      ctx.arc(a.x, a.y, 2.5, 0, Math.PI*2);
      ctx.fillStyle = species[a.s].color;
      ctx.globalAlpha = 0.85;
      ctx.fill(); 
      ctx.globalAlpha = 1;
    }
  }
}

function totalBySpecies(){
  const sum = {};
  species.forEach(sp => sum[sp.key] = 0);
  for(const t of traps){
    for(const k of Object.keys(t.count)){
      sum[k] += t.count[k];
    }
  }
  return sum;
}

function drawBar(){
  const W = barCanvas.width, H = barCanvas.height;
  gctx.clearRect(0, 0, W, H);
  
  const margin = {top: 30, right: 20, bottom: 80, left: 50};
  const chartW = W - margin.left - margin.right;
  const chartH = H - margin.top - margin.bottom;
  
  const sum = totalBySpecies();
  const maxV = Math.max(1, ...Object.values(sum));
  
  gctx.font='bold 14px system-ui'; 
  gctx.fillStyle='#1f2937';
  gctx.fillText('ç¨®åˆ¥ã”ã¨ã®ç·æ•ç²æ•°', margin.left, 20);
  
  gctx.strokeStyle='rgba(0,0,0,0.2)';
  gctx.lineWidth = 1;
  gctx.beginPath();
  gctx.moveTo(margin.left, margin.top);
  gctx.lineTo(margin.left, margin.top + chartH);
  gctx.lineTo(margin.left + chartW, margin.top + chartH);
  gctx.stroke();
  
  const ySteps = 5;
  gctx.font='11px system-ui';
  gctx.fillStyle='rgba(0,0,0,0.6)';
  gctx.textAlign = 'right';
  for(let i=0; i<=ySteps; i++){
    const val = Math.round((maxV / ySteps) * i);
    const y = margin.top + chartH - (chartH / ySteps) * i;
    gctx.fillText(val.toString(), margin.left - 8, y + 4);
    
    gctx.strokeStyle='rgba(0,0,0,0.05)';
    gctx.beginPath();
    gctx.moveTo(margin.left, y);
    gctx.lineTo(margin.left + chartW, y);
    gctx.stroke();
  }
  
  const barWidth = chartW / species.length * 0.7;
  const barSpacing = chartW / species.length;
  
  gctx.textAlign = 'center';
  species.forEach((sp, i) => {
    const x = margin.left + barSpacing * i + (barSpacing - barWidth) / 2;
    const value = sum[sp.key] || 0;
    const barHeight = (value / maxV) * chartH;
    const y = margin.top + chartH - barHeight;
    
    gctx.fillStyle = sp.color;
    gctx.globalAlpha = 0.9;
    gctx.fillRect(x, y, barWidth, barHeight);
    gctx.globalAlpha = 1;
    
    if(value > 0){
      gctx.font='bold 12px system-ui';
      gctx.fillStyle='rgba(0,0,0,0.8)';
      gctx.fillText(value.toString(), x + barWidth/2, y - 6);
    }
    
    gctx.save();
    gctx.translate(x + barWidth/2, margin.top + chartH + 12);
    gctx.rotate(-Math.PI/6);
    gctx.font='11px system-ui';
    gctx.fillStyle='rgba(0,0,0,0.7)';
    gctx.fillText(sp.shortName, 0, 0);
    gctx.restore();
  });
}

function updateTrapTable(){
  ui.tableBody.innerHTML = '';
  
  traps.forEach((t, i) => {
    const tr = document.createElement('tr');
    const counts = species.map(sp => t.count[sp.key] || 0);
    const tot = counts.reduce((a,b) => a+b, 0);
    
    tr.innerHTML = `
      <td>#${i+1}</td>
      <td>${counts[0]}</td>
      <td>${counts[1]}</td>
      <td>${counts[2]}</td>
      <td>${counts[3]}</td>
      <td><strong>${tot}</strong></td>
    `;
    ui.tableBody.appendChild(tr);
  });
  
  drawBar();
}

// å†å®Ÿé¨“æ©Ÿèƒ½ï¼ˆãƒˆãƒ©ãƒƒãƒ—ä½ç½®ä¿æŒï¼‰
function rerunExperiment(){
  if(traps.length === 0){
    alert('ãƒˆãƒ©ãƒƒãƒ—ãŒè¨­ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }
  
  elapsed = 0;
  running = false;
  ui.play.textContent = 'â–¶ å†ç”Ÿ';
  
  // ãƒˆãƒ©ãƒƒãƒ—ã®æ•ç²æ•°ã ã‘ãƒªã‚»ãƒƒãƒˆ
  traps.forEach(t => {
    t.count = species.reduce((o,sp)=>{o[sp.key]=0; return o;}, {});
  });
  
  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†ç”Ÿæˆï¼ˆã‚·ãƒ¼ãƒ‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–ï¼‰
  rng = mulberry32(Date.now() + Math.random() * 100000);
  initAgents(+ui.density.value);
  
  updateTrapTable();
  updateStatus();
  draw();
  drawBar();
  
  alert('ãƒˆãƒ©ãƒƒãƒ—ä½ç½®ã¯ãã®ã¾ã¾ã§ã€å®Ÿé¨“ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\nç’°å¢ƒæ¡ä»¶ã‚’å¤‰æ›´ã—ã¦å†å®Ÿé¨“ã§ãã¾ã™ã€‚');
}

// ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
let last = 0, acc = 0;
function loop(ts){
  if(!last) last = ts;
  const dt = Math.min(0.05, (ts - last) / 1000);
  last = ts;
  const fixed = 1/60;
  
  if(running){
    acc += dt * +ui.speed.value;
    while(acc >= fixed){
      update(fixed);
      acc -= fixed;
    }
    draw();
    drawBar();
  }
  
  requestAnimationFrame(loop);
}

// UIã‚¤ãƒ™ãƒ³ãƒˆ
ui.play.addEventListener('click', () => {
  if(traps.length === 0){
    alert('ãƒˆãƒ©ãƒƒãƒ—ã‚’è¨­ç½®ã—ã¦ãã ã•ã„');
    return;
  }
  running = !running;
  ui.play.textContent = running ? 'â¸ ä¸€æ™‚åœæ­¢' : 'â–¶ å†ç”Ÿ';
});

ui.step.addEventListener('click', () => {
  if(traps.length === 0){
    alert('ãƒˆãƒ©ãƒƒãƒ—ã‚’è¨­ç½®ã—ã¦ãã ã•ã„');
    return;
  }
  const step = 1;
  for(let t=0; t<step*60; t++){
    update(1/60);
  }
  draw();
  drawBar();
  updateTrapTable();
});

ui.rerun.addEventListener('click', rerunExperiment);

ui.reset.addEventListener('click', () => {
  if(confirm('å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒˆãƒ©ãƒƒãƒ—ã®ä½ç½®ã‚‚æ¶ˆå»ã•ã‚Œã¾ã™ï¼‰')){
    setup();
  }
});

ui.speed.addEventListener('input', () => {
  ui.speedVal.textContent = (+ui.speed.value).toFixed(2) + 'Ã—';
});

ui.duration.addEventListener('input', () => {
  targetDuration = +ui.duration.value;
  ui.durVal.textContent = ui.duration.value;
});

ui.moist.addEventListener('input', () => {
  ui.moistVal.textContent = (+ui.moist.value).toFixed(2);
  ui.preset.value = 'custom';
  regenEnv();
});

ui.litter.addEventListener('input', () => {
  ui.litterVal.textContent = (+ui.litter.value).toFixed(2);
  ui.preset.value = 'custom';
  regenEnv();
});

ui.light.addEventListener('input', () => {
  ui.lightVal.textContent = (+ui.light.value).toFixed(2);
  ui.preset.value = 'custom';
  regenEnv();
});

ui.density.addEventListener('input', () => {
  ui.densVal.textContent = ui.density.value;
  initAgents(+ui.density.value);
  draw();
});

ui.bait.addEventListener('input', () => {
  ui.baitVal.textContent = (+ui.bait.value).toFixed(2);
});

ui.trapR.addEventListener('input', () => {
  ui.trapRVal.textContent = ui.trapR.value;
  traps.forEach(t => t.r = +ui.trapR.value);
  draw();
});

ui.clearTrap.addEventListener('click', clearTraps);
ui.autoTrap.addEventListener('click', autoPlaceTraps);
ui.recordBtn.addEventListener('click', recordExperiment);
ui.fillWorksheetBtn.addEventListener('click', fillWorksheetFromRecords);

ui.preset.addEventListener('change', () => {
  const p = ui.preset.value;
  if(p === 'forest'){ setEnvUI(0.75, 0.75, 0.25); }
  else if(p === 'edge'){ setEnvUI(0.55, 0.55, 0.55); }
  else if(p === 'meadow'){ setEnvUI(0.35, 0.25, 0.8); }
  else if(p === 'shade'){ setEnvUI(0.65, 0.55, 0.25); }
  regenEnv();
});

function setEnvUI(m, ltr, li){
  ui.moist.value = m;
  ui.moistVal.textContent = m.toFixed(2);
  ui.litter.value = ltr;
  ui.litterVal.textContent = ltr.toFixed(2);
  ui.light.value = li;
  ui.lightVal.textContent = li.toFixed(2);
}

// ãƒã‚¦ã‚¹æ“ä½œ
let dragTarget = null;

simCanvas.addEventListener('mousedown', (e) => {
  const rect = simCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  if(e.altKey){
    removeNearestTrap(x, y);
    draw();
    return;
  }
  
  for(const t of traps){
    const d = (t.x - x)**2 + (t.y - y)**2;
    if(d <= (t.r + 10) * (t.r + 10)){
      dragTarget = t;
      return;
    }
  }
  
  addTrap(x, y);
  draw();
});

simCanvas.addEventListener('mousemove', (e) => {
  const rect = simCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  const envData = getEnv(x, y);
  ui.envDetail.innerHTML = `
    <div>ğŸ’§ æ¹¿ã‚Š: ${(envData.moist * 100).toFixed(0)}%</div>
    <div>ğŸ‚ è½è‘‰: ${(envData.litter * 100).toFixed(0)}%</div>
    <div>â˜€ï¸ å…‰: ${(envData.light * 100).toFixed(0)}%</div>
  `;
  ui.envOverlay.style.display = 'block';
  
  if(!dragTarget) return;
  
  dragTarget.x = x;
  dragTarget.y = y;
  dragTarget.env = getEnv(x, y);
  updateTrapTable();
  draw();
});

simCanvas.addEventListener('mouseleave', () => {
  ui.envOverlay.style.display = 'none';
});

window.addEventListener('mouseup', () => {
  dragTarget = null;
});

function regenEnv(){
  if(!simCanvas.width || !simCanvas.height) return;
  env = makeField(
    simCanvas.width, 
    simCanvas.height, 
    +ui.moist.value, 
    +ui.litter.value, 
    +ui.light.value
  );
  traps.forEach(t => {
    t.env = getEnv(t.x, t.y);
  });
  updateTrapTable();
  draw();
}

function setup(){
  resizeAll();
  elapsed = 0;
  running = false;
  ui.play.textContent = 'â–¶ å†ç”Ÿ';
  traps.length = 0;
  experimentRecords = [];
  updateExperimentLog();
  targetDuration = +ui.duration.value;
  rng = mulberry32(Date.now() + Math.random() * 100000);
  regenEnv();
  initAgents(+ui.density.value);
  updateTrapTable();
  updateStatus();
  draw();
  drawBar();
}

setup();
requestAnimationFrame(loop);
</script>
</body>
</html>